---
title: "County corrections"
output: html_document
---

```{r setup, include=FALSE}
library(zookeeper)
library(covidcast)
library(tidyverse)
library(lubridate)
df <- suppressMessages(
  covidcast_signal(
    "jhu-csse",
    "confirmed_incidence_num",
    start_day = Sys.Date() - 180,
    geo_type = "county"
  )
)

big_locs <- df %>% 
  group_by(geo_value) %>%
  summarise(total = sum(value)) %>%
  slice_max(total, n = 250) %>% 
  select(geo_value) %>%
  pull()

df <- df %>% filter(geo_value %in% big_locs)

aad <- zookeeper::make_county_corrector(
  manual_flags = tibble::tibble(
    data_source = "jhu-csse",
    signal = "confirmed_incidence_num",
    geo_value = c(
      ## from JHU-CSSE notes 2021-04-17, 2021-04-18
      "29077", "29095", "29183", "29189",
      "01097"
    ),
    time_value = list(
      ## from JHU-CSSE notes 2021-04-17, 2021-04-18
      lubridate::ymd("2021-04-17"), lubridate::ymd("2021-04-17"), lubridate::ymd("2021-04-17"), lubridate::ymd("2021-04-17"),
      lubridate::ymd("2021-04-13")
    ),
    max_lag = c(
      ## from JHU-CSSE notes 2021-04-17, 2021-04-18
      rep_len(150, 4L),
      180
    )
  ),
  corrections_db_path = "county-corrections.RDS"
)
corrected <- aad(df)
corrected <- readRDS("county-corrections.RDS") %>%
  filter(time_value > Sys.Date() - duration(3, "months")) %>%
  select(-data_source) %>%
  pivot_longer(value:corrected)

simple_labs <- function(geo_value) {
  sl <- covidcast::fips_to_name(geo_value)
  sl <- gsub(" County| city| Parish", "", sl)
  state <- evalcast:::fips_2_abbr(substr(names(sl), 1, 2))
  paste(sl, toupper(state))
}
```

```{r, echo = FALSE, fig.height = 120, fig.width = 10, dev="CairoSVG"}
corrected %>% 
  ggplot(aes(time_value)) + geom_line(aes(y=value, color=name)) +
  geom_point(data = filter(corrected, flag | special_flag, name == "value"), 
             aes(y = value), color="orange") +
  facet_wrap(~geo_value , scales = "free", ncol = 3, 
             labeller = labeller(geo_value = simple_labs)) +
  theme_bw() + xlab("") + ylab("") +
  scale_color_viridis_d(begin=.25, end=.75) + 
  theme(legend.position = "none") +
  scale_x_date(date_breaks = "months" , date_labels = "%b")
```



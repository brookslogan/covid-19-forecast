---
title: "State corrections"
output: html_document
---

```{r setup, include=FALSE}
library(zookeeper)
library(covidcast)
library(tidyverse)
library(lubridate)
df <- suppressMessages(
  covidcast_signals(
    state_forecaster_signals$data_source,
    state_forecaster_signals$signal,
    start_day = today - lubridate::days(x = correction_lookback - 30), 
    geo_type = "state"
  )
)

corrected <- df %>% 
  state_corrector(return_all = TRUE) %>% 
  filter(time_value > today - duration(correction_lookback, "days") %>%
  pivot_longer(value:corrected)
```

```{r, echo = FALSE, fig.height = 120, fig.width = 10, dev="CairoSVG"}
corrected %>% 
  ggplot(aes(time_value)) + geom_line(aes(y=value, color=name)) +
  geom_point(data = filter(corrected, flag | special_flag, name == "value"), 
             aes(y = value), color="orange") +
  facet_wrap(~signal + geo_value , scales = "free", ncol = 3) +
  theme_bw() + xlab("") + ylab("") +
  scale_color_viridis_d(begin=.25, end=.75) + 
  theme(legend.position = "none") +
  scale_x_date(date_breaks = "months" , date_labels = "%b")
```




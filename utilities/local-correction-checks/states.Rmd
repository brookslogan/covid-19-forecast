---
title: "State corrections"
output: html_document
---

```{r setup, include=FALSE}
library(zookeeper)
library(covidcast)
library(tidyverse)
library(lubridate)
df <- suppressMessages(
  covidcast_signals(
    "jhu-csse",
    c("deaths_incidence_num","confirmed_incidence_num"),
    start_day = Sys.Date() - duration(6, "months"),
    geo_type = "state"
  )
)

aad <- make_state_corrector(
  manual_flags = tibble(data_source = "jhu-csse", 
                        signal = c(rep("deaths_incidence_num", 3),
                                   "confirmed_incidence_num"),
                        geo_value = c("va","ky","ok","ok"),
                        time_value = list(
                          seq(ymd("2021-02-21"), ymd("2021-03-04"), by = 1),
                          ymd(c("2021-03-18","2021-03-19")),
                          ymd("2021-04-07"), 
                          ymd("2021-04-07")),
                        max_lag = rep(90, 4)),
  corrections_db_path = "state-corrections.RDS")
corrected <- aad(df)
corrected <- readRDS("state-corrections.RDS") %>%
  filter(time_value > Sys.Date() - duration(3, "months")) %>%
  select(-data_source) %>%
  pivot_longer(value:corrected)
```

```{r, echo = FALSE, fig.height = 120, fig.width = 10, dev="CairoSVG"}
corrected %>% 
  ggplot(aes(time_value)) + geom_line(aes(y=value, color=name)) +
  geom_point(data = filter(corrected, flag | special_flag, name == "value"), 
             aes(y = value), color="orange") +
  facet_wrap(~signal + geo_value , scales = "free", ncol = 3) +
  theme_bw() + xlab("") + ylab("") +
  scale_color_viridis_d(begin=.25, end=.75) + 
  theme(legend.position = "none") +
  scale_x_date(date_breaks = "months" , date_labels = "%b")
```



